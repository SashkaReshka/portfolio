<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç ‚Äî –û—Ñ—ñ—Ü—ñ–π–Ω–∏–π –∫—É—Ä—Å –ù–ë–£ ‚Ä¢ –û–ª–µ–∫—Å–∞–Ω–¥—Ä</title>
  <meta name="description" content="–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç –∑–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–º –∫—É—Ä—Å–æ–º –ù–ë–£. –í–∏–±—ñ—Ä –¥–∞—Ç–∏, –ø–æ–Ω–∞–¥ 15 –≤–∞–ª—é—Ç, –º–∏—Ç—Ç—î–≤–∏–π –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫.">
  <meta name="color-scheme" content="light dark" />
  
  <!-- –ú–æ–¥—É–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ —Å–∞–π—Ç—É -->
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/navigation.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/sections.css" />
  <link rel="stylesheet" href="../css/calculators.css" />
  <link rel="stylesheet" href="../css/mobile.css" />
  
</head>
<body>
  <div class="layout">
    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
    <aside id="navigation"></aside>

    <!-- –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main>
      <!-- üß≠ –ö—Ä–∏—Ö—Ç–∏ (—Å—Ç–∞—Ç–∏—á–Ω—ñ, —è–∫ –Ω–∞ projects.html) -->
      <nav class="breadcrumbs" style="max-width:1100px; margin:0 auto;">
        <div class="breadcrumb-item">
          <a href="../index.html" class="breadcrumb-link breadcrumb-home">üè†</a>
        </div>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <div class="breadcrumb-item">
          <a href="../projects.html" class="breadcrumb-link">Interactive Lab</a>
        </div>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <div class="breadcrumb-item">
          <span class="breadcrumb-current">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç</span>
        </div>
      </nav>

      <div class="container">
         <!-- –Ñ–î–ò–ù–ò–ô —Ö–µ–¥–µ—Ä —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
    <div class="section">
      <h1>üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç</h1>
      <p>–ö–æ–Ω–≤–µ—Ä—Ç—É–π—Ç–µ –≤–∞–ª—é—Ç–∏ –∑–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–º –∫—É—Ä—Å–æ–º –ù–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫—É –£–∫—Ä–∞—ó–Ω–∏</p>
    </div>

            <!-- –¢—ñ–ª–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
            <div class="calc-body">
              <!-- –î–∞—Ç–∞ —ñ —Å—É–º–∞ -->
              <div class="calc-grid-2">
                <div class="calc-form-group">
                  <label class="calc-label">–î–∞—Ç–∞ –∫—É—Ä—Å—É</label>
                  <input type="date" id="datePick" class="calc-input" />
                </div>
                <div class="calc-form-group">
                  <label class="calc-label">–°—É–º–∞</label>
                  <div class="calc-input-icon">
                    <input type="number" id="amount" class="calc-input" min="0" step="0.01" value="100" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É" />
                  </div>
                </div>
              </div>

              <!-- –í–∏–±—ñ—Ä –≤–∞–ª—é—Ç -->
              <div class="calc-grid-swap">
                <div class="calc-form-group">
                  <label class="calc-label">–ó –≤–∞–ª—é—Ç–∏</label>
                  <div class="calc-select-wrapper">
                    <select id="currencyFrom" class="calc-select"></select>
                  </div>
                </div>

                <button class="calc-swap-btn" id="btnSwap" title="–ü–æ–º—ñ–Ω—è—Ç–∏ –º—ñ—Å—Ü—è–º–∏">‚áÑ</button>

                <div class="calc-form-group">
                  <label class="calc-label">–£ –≤–∞–ª—é—Ç—É</label>
                  <div class="calc-select-wrapper">
                    <select id="currencyTo" class="calc-select"></select>
                  </div>
                </div>
              </div>

              <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
              <div class="calc-result" id="result">
                <div class="calc-result-label" id="resultLabel">–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó</div>
                <div class="calc-result-value" id="resultValue">‚Äî</div>
                <div class="calc-result-meta" id="resultMeta">–ö—É—Ä—Å: ‚Äî ‚Ä¢ –°—Ç–∞–Ω–æ–º –Ω–∞: ‚Äî</div>
                <!-- –ü–∞—Å—Ö–∞–ª–∫—É –ù–ï –¥–æ–¥–∞—î–º–æ –≤ HTML, –≤–æ–Ω–∞ –∑‚Äô—è–≤–∏—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ JS -->
              </div>

              <!-- –ü–ª–∏—Ç–∫–∏ (2 —à—Ç) -->
              <div class="calc-tiles">
                <div class="calc-tile">
                  <div class="calc-tile-label">–ö—É—Ä—Å</div>
                  <div class="calc-tile-value" id="rateFrom">‚Äî</div>
                </div>
                <div class="calc-tile">
                  <div class="calc-tile-label">–ó–≤–æ—Ä–æ—Ç–Ω–∏–π –∫—É—Ä—Å</div>
                  <div class="calc-tile-value" id="rateTo">‚Äî</div>
                </div>
              </div>

              <!-- –Ü–Ω—Ñ–æ -->
              <div class="calc-info">
                <strong>–í–∞–∂–ª–∏–≤–æ:</strong> –ö—É—Ä—Å–∏ –ù–ë–£ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è —â–æ–¥–µ–Ω–Ω–æ –±–ª–∏–∑—å–∫–æ 12:00.
                –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –∫–µ—à—ñ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É.
              </div>
            </div>

            <!-- –§—É—Ç–µ—Ä -->
            <div class="calc-footer">
              <div class="calc-footer-text">¬© 2025 ‚Ä¢ –î–∞–Ω—ñ –∑ bank.gov.ua</div>
              <div class="calc-footer-badge" id="cacheStatus">–ö–µ—à: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞...</div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- JavaScript -->
  <script src="../js/theme.js"></script>
  <script src="../js/nav.js"></script>
  <script src="../js/utils.js"></script>

  <!-- –õ–æ–≥—ñ–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ + –¥–∏–Ω–∞–º—ñ—á–Ω–∞ –ø–∞—Å—Ö–∞–ª–∫–∞ -->
<script>
  (function() {
    'use strict';

    // –ï–õ–ï–ú–ï–ù–¢–ò DOM
    const elements = {
      date: document.getElementById('datePick'),
      amount: document.getElementById('amount'),
      from: document.getElementById('currencyFrom'),
      to: document.getElementById('currencyTo'),
      swap: document.getElementById('btnSwap'),
      result: document.getElementById('result'),
      resultLabel: document.getElementById('resultLabel'),
      resultValue: document.getElementById('resultValue'),
      resultMeta: document.getElementById('resultMeta'),
      rateFrom: document.getElementById('rateFrom'),
      rateTo: document.getElementById('rateTo'),
      error: document.getElementById('error'),
      cacheStatus: document.getElementById('cacheStatus')
    };

    // –ö–û–ù–§–Ü–ì
    const NBU_API = 'https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange';
    const LOCALE = 'uk-UA';
    const fmt2 = new Intl.NumberFormat(LOCALE,{minimumFractionDigits:2,maximumFractionDigits:2});
    const fmt4 = new Intl.NumberFormat(LOCALE,{minimumFractionDigits:4,maximumFractionDigits:4});

    // –°–¢–ê–ù
    let rates = new Map();
    let exchangeDate = null;

    function init() {
      const today = new Date().toISOString().slice(0,10);
      elements.date.value = today;

      elements.date.addEventListener('change', loadRates);
      elements.amount.addEventListener('input', calculate);
      elements.from.addEventListener('change', calculate);
      elements.to.addEventListener('change', calculate);
      elements.swap.addEventListener('click', swapCurrencies);

      loadRates();
    }

async function loadRates() {
        try {
          hideError();

          const dateISO = elements.date.value || new Date().toISOString().slice(0, 10);
          const dateYMD = dateISO.replace(/-/g, '');

          const cacheKey = `nbu_rates_${dateYMD}`;
          const cached = localStorage.getItem(cacheKey);

          // --- 1. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –π –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É –∫–µ—à—É ---
          if (cached) {
            try {
              const raw = JSON.parse(cached);
              let payload;

              if (Array.isArray(raw)) {
                // –°—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç: –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ø—Ä–æ—Å—Ç–æ –º–∞—Å–∏–≤ –∑ API
                payload = { list: raw, dateISO };
              } else if (raw && Array.isArray(raw.list)) {
                // –ù–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç: { list, dateISO }
                payload = {
                  list: raw.list,
                  dateISO: raw.dateISO || dateISO
                };
              } else {
                throw new Error('Unknown cache format');
              }

              applyRates(payload);
              elements.cacheStatus.textContent = '–ö–µ—à: localStorage ‚úì';
              return;
            } catch (e) {
              console.warn('Bad cache format, refetching from API', e);
              // –Ø–∫—â–æ –∫–µ—à –±–∏—Ç–∏–π ‚Äî –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –π —Ç—è–≥–Ω–µ–º–æ —Å–≤—ñ–∂—ñ –¥–∞–Ω—ñ
              localStorage.removeItem(cacheKey);
            }
          }

          // --- 2. –Ø–∫—â–æ –∫–µ—à—É –Ω–µ–º–∞—î –∞–±–æ –≤—ñ–Ω –±–∏—Ç–∏–π ‚Äî –π–¥–µ–º–æ –≤ API ---
          elements.cacheStatus.textContent = '–ö–µ—à: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
          const response = await fetch(
            `${NBU_API}?date=${dateYMD}&json`,
            { cache: 'no-store' }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const list = await response.json(); // –º–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ –ù–ë–£

          const payload = { list, dateISO };
          localStorage.setItem(cacheKey, JSON.stringify(payload));

          applyRates(payload);
          elements.cacheStatus.textContent = '–ö–µ—à: –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úì';
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤:', error);
          showError();
          if (elements.cacheStatus) {
            elements.cacheStatus.textContent = '–ö–µ—à: –ø–æ–º–∏–ª–∫–∞ ‚úó';
          }
        }
      }

    function applyRates(payload){
      rates.clear();
      // UAH = 1
      rates.set('UAH', {
        cc:'UAH',
        txt:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –≥—Ä–∏–≤–Ω—è',
        rate:1,
        exchangedate: formatDate(payload.dateISO)
      });

      (payload.list||[]).forEach(it=>{
        if (it && it.cc && typeof it.rate === 'number'){
          rates.set(it.cc.toUpperCase(), {
            cc: it.cc.toUpperCase(),
            txt: it.txt,
            rate: it.rate,
            exchangedate: it.exchangedate
          });
        }
      });
      exchangeDate = payload.dateISO;
      buildSelects();
      calculate();
    }

    function buildSelects(){
      const opts = [];
      const preferred = ['UAH','USD','EUR','PLN','GBP','CHF','CZK','HUF','RON','TRY','CAD','JPY','CNY','GEL','MDL'];
      const seen = new Set();
      preferred.forEach(c=>{
        if(rates.has(c)&&!seen.has(c)){
          const cur=rates.get(c);
          opts.push(new Option(`${c} ‚Äî ${cur.txt}`, c));
          seen.add(c);
        }
      });
      Array.from(rates.keys()).sort().forEach(c=>{
        if(!seen.has(c)){
          const cur=rates.get(c);
          opts.push(new Option(`${c} ‚Äî ${cur.txt}`, c));
        }
      });

      const prevFrom = elements.from.value;
      const prevTo = elements.to.value;
      elements.from.innerHTML = '';
      elements.to.innerHTML = '';
      opts.forEach(o=>elements.from.add(o.cloneNode(true)));
      opts.forEach(o=>elements.to.add(o.cloneNode(true)));
      elements.from.value = prevFrom || 'USD';
      elements.to.value = prevTo || 'UAH';
    }

    function calculate(){
      hideError();
      const amount = parseFloat(elements.amount.value) || 0;
      const fromCode = elements.from.value;
      const toCode = elements.to.value;
      if (!rates.size || !fromCode || !toCode){
        elements.resultValue.textContent='‚Äî';
        return;
      }

      const fromRate = rates.get(fromCode)?.rate;
      const toRate = rates.get(toCode)?.rate;
      if (!(fromRate>0) || !(toRate>0)){
        elements.resultValue.textContent='‚Äî';
        return;
      }

      const res = amount * (fromRate / toRate);
      const cross = fromRate / toRate;
      const inv = 1 / cross;

      elements.resultValue.textContent = isFinite(res) ? `${fmt2.format(res)} ${toCode}` : '‚Äî';
      elements.resultLabel.textContent = amount ? `${fmt2.format(amount)} ${fromCode} =` : '–†–µ–∑—É–ª—å—Ç–∞—Ç';
      elements.resultMeta.textContent = `–ö—É—Ä—Å: 1 ${fromCode} = ${fmt4.format(cross)} ${toCode} ‚Ä¢ ${formatDate(exchangeDate)}`;

      elements.rateFrom.textContent = `1 ${fromCode} = ${fmt4.format(cross)} ${toCode}`;
      elements.rateTo.textContent   = `1 ${toCode} = ${fmt4.format(inv)} ${fromCode}`;

      elements.result.classList.add('pulse');
      setTimeout(()=>elements.result.classList.remove('pulse'), 400);
    }

    function swapCurrencies(){
      const tmp = elements.from.value;
      elements.from.value = elements.to.value;
      elements.to.value = tmp;
      calculate();
    }

    function formatDate(iso){
      if (!iso) return '‚Äî';
      const d = new Date(iso+'T00:00:00');
      return d.toLocaleDateString('uk-UA',{year:'numeric',month:'long',day:'numeric'});
    }

    function showError(){
      if(!elements.error) return;
      elements.error.classList.add('show');
    }
    function hideError(){
      if(!elements.error) return;
      elements.error.classList.remove('show');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
</body>
</html>
